[
    {
        "UpdateStageName": "Run PostgreSQL Server",
        "UpdateSourcePlatform": "Linux",
        "UpdateSource": "Executable",
        "UpdateSourceData": "/bin/bash",
        "UpdateSourceArgs": "-c \"cd postgresql && export PGPASSWORD={{AMPPassword}} && pgsql/bin/pg_isready --host=\\\"{{$FullBaseDir}}run\\\" --port={{$ServerPort}} --username=amp --dbname=postgres >/dev/null 2>&1 && exit 0 || pgsql/bin/postgres -D \\\"{{$FullBaseDir}}data\\\" -k \\\"{{$FullBaseDir}}run\\\" --external_pid_file=\\\"{{$FullBaseDir}}run/postgres.pid\\\" --listen_addresses=\\\"{{$ApplicationIPBinding}}\\\" &\"",
        "RunInBackground": true,
        "SkipOnFailure": false
    },
    {
        "UpdateStageName": "Wait For Server Start",
        "UpdateSourcePlatform": "Linux",
        "UpdateSource": "Executable",
        "UpdateSourceData": "/bin/bash",
        "UpdateSourceArgs": "-c \"cd postgresql && export PGPASSWORD={{AMPPassword}} && timeout=60; while ((timeout--)); do pgsql/bin/pg_isready --host=\\\"{{$FullBaseDir}}run\\\" --port={{$ServerPort}} --username=amp --dbname=postgres >/dev/null 2>&1 && exit 0 || sleep 1; done; ((timeout<0)) && { echo \\\"PostgreSQL server failed to start. Aborting\\\"; exit 1; }\"",
        "SkipOnFailure": false
    }
]