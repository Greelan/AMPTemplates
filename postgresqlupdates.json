[
    {
        "UpdateStageName": "Create Data Directory",
        "UpdateSourcePlatform": "Linux",
        "UpdateSource": "CreateDirectory",
        "UpdateSourceArgs": "{{$FullBaseDir}}data"
    },
    {
        "UpdateStageName": "Create Run Directory",
        "UpdateSourcePlatform": "Linux",
        "UpdateSource": "CreateDirectory",
        "UpdateSourceArgs": "{{$FullBaseDir}}run"
    },
    {
        "UpdateStageName": "Create Build Directory",
        "UpdateSourcePlatform": "Linux",
        "UpdateSource": "CreateDirectory",
        "UpdateSourceArgs": "{{$FullRootDir}}build"
    },
    {
        "UpdateStageName": "Download PostgreSQL",
        "UpdateSourcePlatform": "Linux",
        "UpdateSource": "Executable",
        "UpdateSourceData": "/bin/bash",
        "UpdateSourceArgs": "-c \"ServerVersion=\\\"{{ServerVersion}}\\\"; CustomServerVersion=\\\"{{CustomServerVersion}}\\\"; cd postgresql/build && rm -rf ./* >/dev/null 2>&1 && if [[ -z \\\"$ServerVersion\\\" ]]; then if [[ ! \\\"$CustomServerVersion\\\" =~ ^(13|14|15|16|17)\\.[0-9]++$ ]]; then echo \\\"Invalid PostgreSQL version format specified\\\" && exit 1; else DownloadURL=https://ftp.postgresql.org/pub/source/v$CustomServerVersion/postgresql-$CustomServerVersion.tar.gz && OutputMessage=\\\"PostgreSQL v$CustomServerVersion downloaded\\\"; fi; else LatestVersion=$(wget -qO- https://www.postgresql.org/versions.json | jq -r \\\".versions[] | select(.major == \\\\\\\"$ServerVersion\\\\\\\") | .latestMinor\\\") && DownloadURL=https://ftp.postgresql.org/pub/source/v$LatestVersion/postgresql-$LatestVersion.tar.gz && OutputMessage=\\\"PostgreSQL v$LatestVersion downloaded\\\"; fi; wget -qO postgresql.tar.gz $DownloadURL && tar -xzf postgresql.tar.gz --strip-components=1 >/dev/null 2>&1 && rm -rf postgresql.tar.gz >/dev/null 2>&1 && echo \\\"$OutputMessage\\\"\"",
        "UpdateSourceConditionSetting": "DisablePostgreSQLDownload",
        "UpdateSourceConditionValue": "false",
        "SkipOnFailure": false
    },
    {
        "UpdateStageName": "Build PostgreSQL",
        "UpdateSourcePlatform": "Linux",
        "UpdateSource": "Executable",
        "UpdateSourceData": "/bin/bash",
        "UpdateSourceArgs": "-c \"cd postgresql/build && ./configure --prefix=\\\"{{$FullBaseDir}}\\\" && make && make install\"",
        "UpdateSourceConditionSetting": "DisablePostgreSQLDownload",
        "UpdateSourceConditionValue": "false",
        "SkipOnFailure": false
    },
    {
        "UpdateStageName": "Initialize PostgreSQL",
        "UpdateSourcePlatform": "Linux",
        "UpdateSource": "Executable",
        "UpdateSourceData": "/bin/bash",
        "UpdateSourceArgs": "-c \"cd postgresql/pgsql && { [[ -f ./data/PG_VERSION ]] || bin/initdb --pgdata=\\\"{{$FullBaseDir}}data\\\" --auth=md5 --username=amp --pwfile=<(echo \\\"{{AMPPassword}}\\\") } && { grep -q \\\"# Custom AMP rules\\\" \\\"{{$FullBaseDir}}data/pg_hba.conf\\\" || echo -e \\\"# Custom AMP rules\nlocal   all             all                                     md5\nhost    all             all             0.0.0.0/0               md5\\\" >> \\\"{{$FullBaseDir}}data/pg_hba.conf\\\" }\"",
        "SkipOnFailure": false
    }
]